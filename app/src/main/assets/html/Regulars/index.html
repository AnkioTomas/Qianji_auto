<html>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>文本识别规则编辑</title>

    <link href="../Public/css/regular22.css" rel="stylesheet">
    <link href="../Public/css/regulars.css" rel="stylesheet">
    <link href="../Public/css/tip.css" rel="stylesheet">
</head>
<body>
<div class="rule">
    <form action="" onsubmit="return false">
        <div class="sort_name">
            <label for="sort_name">规则名称</label>
            <div class="rule_content">
                <div class="rule_content1 sort_rule_remark">
                    <input id="sort_name" placeholder="分类规则名称" type="text">
                </div>
            </div>
        </div>
        <div class="sort_remark">
            <label for="sort_remark">规则说明</label>
            <div class="rule_content">
                <div class="rule_content1 textarea">
                    <textarea cols="30" id="sort_remark" name="sort_remark" placeholder="请输入说明..."
                              rows="5"></textarea>
                </div>
            </div>
        </div>
        <div class="sort_package">
            <label for="sort_package">适用app包名</label>
            <div class="rule_content">
                <div class="rule_content1 sort_package1">
                    <input id="sort_package" placeholder="如：cn.ankio.net" type="text">
                </div>
            </div>
        </div>

        <div class="sort_remark">
            <label>正则测试</label>
        </div>
        <div class="main " style="background-color: #fff">
            <div class="inner">
                <div id="preset_regex">
                    <h4>常用正则：</h4>
                    <ul class="clearfix">
                        <li><a data-regex="\d+(\.\d+)?" href="#">匹配浮点数（常用于金额）</a></li>
                        <li><a data-regex="[\u4e00-\u9fa5]+" href="#">匹配中文</a></li>
                        <li><a data-regex="[\s\S]*" href="#">匹配任意字符</a></li>
                        <li><a data-regex=".*" href="#">匹配任意不换行字符</a></li>
                    </ul>
                </div>
                <h4>正则表达式：</h4>
                <div class="regex-wrapper mgb10">
                    <textarea cols="1000" id="regex_input" rows="3" style="display: none;"
                              tabindex="1"></textarea>
                </div>
                <h4>测试数据：</h4>
                <div class="str-wrapper">
                    <textarea cols="100" id="str_input" rows="10" style="display: none;"
                              tabindex="2"></textarea>
                </div>
                <h3 style="display: none">共找到 <var id="result_count">0</var> 处匹配结果</h3>
                <pre id="result_content" style="display: none"></pre>
                <h3>共找到 <var id="result_count2">0</var> 处分组结果</h3>
                <pre id="result_content2"></pre>
            </div>
        </div>



        <div class="project_location">
            <label>匹配项目所在位置</label>
            <div class="rule_content">


                <div class="rule_content2">
                    <label for="account_name1">账户名称1</label>
                    <input id="account_name1" placeholder="可输入数字或中文" type="text">
                </div>

                <div class="rule_content2">
                    <label for="account_name2">账户名称2</label>
                    <input id="account_name2" placeholder="可输入数字或中文" type="text">
                </div>

                <div class="rule_content2">
                    <label for="type">收支类型</label>
                    <select id="type" name="type">
                        <option selected value="0"> 支出</option>
                        <option value="1"> 收入</option>
                        <option value="2"> 转账</option>
                        <option value="3"> 信用还款</option>
                    </select>
                </div>

                <div class="rule_content2">
                    <label for="silent">后台交易</label>
                    <select id="silent" name="silent">
                        <option selected value="0"> 是</option>
                        <option value="1"> 否</option>
                    </select>
                </div>

                <div class="rule_content2">
                    <label for="money">金额</label>
                    <input id="money" placeholder="可输入数字" type="text">
                </div>

                <div class="rule_content2">
                    <label for="fee">手续费</label>
                    <input id="fee" placeholder="可输入数字" type="text" value="0">
                </div>

                <div class="rule_content2">
                    <label for="shopName">商户名称</label>
                    <input id="shopName" placeholder="可输入数字或中文" type="text">
                </div>

                <div class="rule_content2">
                    <label for="shopRemark">商户备注</label>
                    <input id="shopRemark" placeholder="可输入数字或中文" type="text">
                </div>

                <div class="rule_content2">
                    <label for="source">账单信息来源</label>
                    <input id="source" placeholder="暂时留空" type="text">
                </div>
            </div>
        </div>

        <div class="buttons">
            <button class="button1" id="test" name="测试">测试</button>
            <button id="save" name="保存">保存</button>
        </div>
    </form>
</div>
<div class="modal" id="tip">

    <!-- 弹窗内容 -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close cancel2">&times;</span>
            <h4>测试结果</h4>
        </div>
        <div class="modal-body">
            <p id="tip_content"></p>
        </div>
        <div class="modal-footer">
            <div class="buttons">
                <button class="cancel2">确定</button>
            </div>
        </div>
    </div>
</div>
<script src="../Public/jquery/jquery.js"></script>
<script src="../Public/jquery/1.js"></script>

<script src="../Public/jquery/base16.js"></script>
<script src="../Public/jquery/DataUtils.js"></script>
<script>

    function showTip(str){
        $("#tip_content").html(str)
        $("#tip").css("display", "block")
    }
    function Toast(msg, duration) {
        duration = isNaN(duration) ? 3000 : duration;
        var m = document.createElement('div');
        m.innerHTML = msg;
        m.style.cssText = "max-width:60%;min-width: 150px;padding:0 14px;height: 40px;color: rgb(255, 255, 255);line-height: 40px;text-align: center;border-radius: 4px;position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 999999;background: rgba(0, 0, 0,.7);font-size: 16px;";
        document.body.appendChild(m);
        setTimeout(function () {
            var d = 0.5;
            m.style.webkitTransition = '-webkit-transform ' + d + 's ease-in, opacity ' + d + 's ease-in';
            m.style.opacity = '0';
            setTimeout(function () {
                document.body.removeChild(m)
            }, d * 1000);
        }, duration);
    }
    $(".cancel2").on("click", function (e) {
        //  $("#myModal").css("display", "none")
        $("#tip").css("display", "none")
    })

    function getType(jsArrElement) {
        if(jsArrElement==="0")return "支出"
        if(jsArrElement==="1")return "收入"
        if(jsArrElement==="2")return "转账"
        if(jsArrElement==="3")return "信用还款"
        return jsArrElement;
    }

    $("#test").on("click", function (e) {
        var js=getJs();
        if(js==="")
            return;
        const jsData = getFunction($("#str_input").val(),js)
        console.log(jsData)
        try {
            const ret = eval(jsData);
            var jsArr=ret.split("|")
            if(jsArr.length!==10){
                Toast("奇怪了，好像有奇怪的东西混入了~",2000)
                return;
            }
            let str = "";
            str+="账户名称1："+jsArr[1]+"<br>"
            str+="账户名称2："+jsArr[4]+"<br>"
            str+="收支类型："+getType(jsArr[2])+"<br>"
            str+="后台交易："+(jsArr[6]==="1"?"是":"否")+"<br>"
            str+="金额："+jsArr[3]+"<br>"
            str+="手续费："+jsArr[8]+"<br>"
            str+="商户名称："+jsArr[5]+"<br>"
            str+="商户备注："+jsArr[0]+"<br>"
            str+="账单信息来源："+jsArr[7]+"<br>"

            showTip(str)
        } catch (e) {
            showTip("自动识别执行出错：" + e)
            // console.log(e)
        }
    });
    $("#save").on("click", function (e) {
       window.AndroidJS.Save(getData(),getQueryVariable("id"));
    });

    $("#result_count").bind("DOMNodeInserted",function(e){
        var data = $("#regex_input").val();
        var pattern = eval("/"+data+"/");
        var str="";
        var len=1;
        if(pattern.test($("#str_input").val())){
            var array = pattern.exec($("#str_input").val());
           // console.log(array)
            len=array.length;
            for(var i=1;i<len;i++){
                str+="<b>【"+i+"】</b> "+array[i]+"<br>"
            }

        }
        $("#result_count2").html((len-1).toString());
        $("#result_content2").html(str);
    });
    function getQueryVariable(variable)
    {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            const pair = vars[i].split("=");
            if(pair[0] === variable){return pair[1];}
        }
        return undefined;
    }
    String.format = function () {
        let s = arguments[0];
        for (let i = 0; i < arguments.length - 1; i++) {
            const reg = new RegExp("%s", "m");
            s = s.replace(reg, arguments[i + 1]);
        }
        return s;
    }
    function setData(){
        let data = getQueryVariable("data");
        const id = getQueryVariable("id");
        //const type= getQueryVariable("type");
        if(data!==undefined){
            data=Base64.decode(data);
            console.log(data)
            const dataUtils = new DataUtils();
            dataUtils.parse(data);
            $("#sort_name").val(dataUtils.get("name"))
            $("#sort_remark").val(dataUtils.get("des"))
            $("#regex_input").html(dataUtils.get("regular"))
            $("#sort_package").val(dataUtils.get("fromApp"))
            $("#str_input").html(dataUtils.get("text"))

            const dataUtils2 = new DataUtils();
            dataUtils2.parse(dataUtils.get("tableList"))
            $("#account_name1").val(dataUtils2.get("account1"))
            $("#account_name2").val(dataUtils2.get("account2"))
            $("#type").val(dataUtils2.get("type"))
            $("#source").val(dataUtils2.get("source"))
            $("#silent").val(dataUtils2.get("silent"))
            $("#money").val(dataUtils2.get("money"))
            $("#fee").val(dataUtils2.get("fee"))
            $("#shopName").val(dataUtils2.get("shopName"))
            $("#shopRemark").val(dataUtils2.get("shopRemark"))

        }
    }
    function getData() {

        const dataUtils2 = new DataUtils();
        dataUtils2.put("account1", $("#account_name1").val())
        dataUtils2.put("account2", $("#account_name2").val())
        dataUtils2.put("type", $("#type").val())
        dataUtils2.put("source", $("#source").val())
        dataUtils2.put("silent", $("#silent").val())
        dataUtils2.put("money", $("#money").val())
        dataUtils2.put("fee", $("#fee").val())
        dataUtils2.put("shopName", $("#shopName").val())
        dataUtils2.put("shopRemark", $("#shopRemark").val())


        const dataUtils = new DataUtils();
        dataUtils.put("name", $("#sort_name").val())
        dataUtils.put("text", $("#str_input").val())
        dataUtils.put("regular", $("#regex_input").val())
        dataUtils.put("fromApp", $("#sort_package").val())

        dataUtils.put("des", $("#sort_remark").val())
        dataUtils.put("identify", getQueryVariable("type"))
        dataUtils.put("tableList",dataUtils2.toString())
        return dataUtils.toString();
    }
    function getJs(){
        var data = "pattern= /%s/;\n" +

            "        if(pattern.test(body)){\n" +
            "                var array = pattern.exec(body);\n" +
            "                var remarkNum='%s',accountNum='%s',typeNum='%s',moneyNum='%s',shopNameNum='%s',accountNum2='%s',clientNum='%s',sourceNum='%s',feeNum='%s';\n" +
            "                \n" +
            "                for(var i=1;i<array.length;i++){\n" +
            "                        \n" +
            "                        var rep=\"$\"+i.toString();\n" +
            "                        var repStr=array[i];\n" +
            "                        \n" +
            "                        remarkNum=remarkNum.replace(rep,repStr);\n" +
            "                        accountNum=accountNum.replace(rep,repStr);\n" +
            "                        typeNum=typeNum.replace(rep,repStr);\n" +
            "                        moneyNum=moneyNum.replace(rep,repStr);\n" +
            "                        shopNameNum=shopNameNum.replace(rep,repStr);\n" +
            "                        accountNum2=accountNum2.replace(rep,repStr);\n" +
            "                        clientNum=clientNum.replace(rep,repStr);\n" +
            "                        sourceNum=sourceNum.replace(rep,repStr);\n" +
            "                        feeNum=feeNum.replace(rep,repStr);\n" +
            "                \n" +
            "                }   \n" +
            "             return remarkNum+'|'+accountNum+'|'+typeNum+'|'+moneyNum+'|'+accountNum2+'|'+shopNameNum+'|'+clientNum+'|'+sourceNum+'|'+feeNum+'|'+index\n" +
            "       }        ";



        //获取名称
        if ($("#sort_name").val() === "") {
            Toast("名称不能为空", 2000);
            return "";
        }
        //获取名称

        if ($("#regex_input").val() === "") {
            Toast("正则不能为空", 2000);
            return "";
        }
        if ($("#str_input").val() === "") {
            Toast("测试文本不能为空", 2000);
            return "";
        }
        var dataUtilsStr=getData();
        var dataUtils1=new DataUtils();
        dataUtils1.parse(dataUtilsStr);
        var dataUtils=new DataUtils();
        dataUtils.parse(dataUtils1.get("tableList"))
        data = String.format(data, dataUtils1.get("regular"), dataUtils.get("shopRemark"), dataUtils.get("account1"), dataUtils.get("type"), dataUtils.get("money"), dataUtils.get("shopName"), dataUtils.get("account2"), dataUtils.get("silent"), dataUtils.get("source"), dataUtils.get("fee"));
        return data;
    }
    function getFunction( body, regex) {
        var js = "function getData(body){ \n" +
            "        var remark,account,type,money,shopName,account2,client,source,fee,index=0 ;\n" +
            "        %s\n" +
            "return remark+'|'+account+'|'+type+'|'+money+'|'+shopName+'|'+account2+'|'+client+'|'+source+'|'+fee +'|'+index\n" +
            "};\n" +
            "getData('%s');";

        return String.format(js, regex, body);

    }
    setData();
</script>
<script src="../Public/jquery/2.js"></script>
</body>
</html>
