<html>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>规则编辑(JS)</title>
    <link href="../Public/css/category.css" rel="stylesheet">

    <link href="../Public/hight/codemirror.css" rel="stylesheet">
    <script src="../Public/hight/codemirror.js"></script>
    <script src="../Public/hight/javascript.js"></script>

</head>
<body>
<div class="rule">
    <form action="" onsubmit="return false">
        <div class="sort_name">
            <label for="sort_name">规则名称</label>
            <div class="rule_content">
                <div class="rule_content1">
                    <input id="sort_name" placeholder="分类规则名称" type="text">
                </div>
            </div>

            <div class="rule_content">
                <div class="rule_content1">

                    <textarea cols="30" id="sort_remark" name="sort_remark" placeholder="请输入备注..."
                              rows="5"></textarea>
                </div>
            </div>
        </div>
        <input id="cate_id" style="display: none" type="text">
        <div class="sort_name">
            <label>Js编辑器风格</label>
            <div class="rule_content">
                <div class="rule_content3">
                    <button>自动换行</button>
                    <div class="testswitch">
                        <input class="testswitch-checkbox" id="js_style" type="checkbox">
                        <label class="testswitch-label" for="js_style">
                            <span class="testswitch-inner" data-off="OFF" data-on="ON"></span>
                            <span class="testswitch-switch"></span>
                        </label>
                    </div>
                </div>
            </div>

        </div>
        <div class="sort_name">
            <label for="sort_name">JS代码</label>
            <div>
                <textarea id="code" name="code">/*
* 可用变量
*
* shopName 商户名称,shopRemark 商户备注,type 账单类型（支出、收入）,hour 当前时,minute 当前分,source 账单来源,money 金额
*
* 可用内置函数（判断是否在当前时间段） isInTimeInner(minTime, maxTime,timeHour,timeMinute)
* minTime 最小时间（如12:00）, maxTime 最大时间（如12:00）,timeHour 当前时,timeMinute 当前分
*/

if(true)return '其它';</textarea>
            </div>
        </div>


        <div class="buttons">
            <button class="button1" id="test">测试</button>
            <button id="save">保存</button>
        </div>
    </form>
</div>


<!-- 弹窗 -->
<div class="modal" id="myModal">

    <!-- 弹窗内容 -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close cancel">&times;</span>
            <h4>请完善测试数据</h4>
        </div>
        <div class="modal-body">
            <div class="time_condition">
                <!--   <label>当前时间</label>-->
                <div class="rule_content">
                    <div class="rule_content3">
                        <button>
                            当前时间
                        </button>
                        <input id="time_now" placeholder="仅可输入数字，24小时计数法" type="time">
                    </div>
                </div>
            </div>

            <div class="price_condition">
                <!-- <label>金额大小</label>-->
                <div class="rule_content">
                    <div class="rule_content3">
                        <button>
                            金额
                        </button>
                        <input id="price_now" placeholder="仅可输入数字" type="number" value="0.1">
                    </div>
                </div>
            </div>

            <div class="merchant_name">
                <!-- <label>商户名称满足条件</label>-->
                <div class="rule_content">
                    <div class="rule_content3">
                        <button>
                            商户名称
                        </button>
                        <input id="shop_name" type="text">
                    </div>
                </div>
            </div>
            <div class="merchant_name">
                <!-- <label>商户名称满足条件</label>-->
                <div class="rule_content">
                    <div class="rule_content3">
                        <button>
                            商户备注
                        </button>
                        <input id="shop_remark" type="text">
                    </div>
                </div>
            </div>
            <div class="merchant_name">
                <!-- <label>商户名称满足条件</label>-->
                <div class="rule_content">
                    <div class="rule_content3">
                        <button>
                            账单类型
                        </button>
                        <input id="type" type="text">
                    </div>
                </div>
            </div>
            <div class="merchant_name">


                <div class="rule_content">

                    <div class="rule_content3">
                        <button>消费类型</button>
                        <select id="bill_type">
                            <option selected value="0"> 支出</option>
                            <option value="1"> 收入</option>

                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="buttons">
                    <button class="button1" id="go">测试</button>
                    <button class="cancel">取消</button>
                </div>
            </div>
        </div>

    </div>
</div>
<div class="modal" id="tip">

    <!-- 弹窗内容 -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close cancel2">&times;</span>
            <h4>测试结果</h4>
        </div>
        <div class="modal-body">
            <p id="tip_content"></p>
        </div>
        <div class="modal-footer">
            <div class="buttons">
                <button class="cancel2">确定</button>
            </div>
        </div>
    </div>
</div>
<script src="../Public/jquery/jquery.js"></script>
<script src="../Public/jquery/DataUtils.js"></script>
<!--<script src="../Public/jquery/category.js"></script>-->
<script>
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        matchBrackets: true,
        lineWrapping: true,
    });
</script>
<script>
    $(function () {

        $("#category").on("click", function (e) {
            try {
                window.AndroidJS.SelectCategory($("#consumption_type").val());
            } catch (e) {
                //不是在安卓WebVIew打开
                const word = prompt("请输入分类名称", "");
                if (word) {
                    setCategory(word, "https://pic.dreamn.cn/uPic/2021032310470716164676271616467627123WiARFwd8b1f5bdd0fca9378a915d8531cb740b.png")
                }
            }

        });


        function showTip(str){
            $("#tip_content").html(str)
            $("#tip").css("display", "block")
        }
        $(".cancel").on("click", function (e) {
            $("#myModal").css("display", "none")
          //  $("#tip").css("display", "none")
        })
        $(".cancel2").on("click", function (e) {
          //  $("#myModal").css("display", "none")
            $("#tip").css("display", "none")
        })
        $("#test").on("click", function (e) {
         //   console.log(e)
            $("#myModal").css("display", "block")
            //  window.AndroidJS.Test(getData());
        });
        $("#go").on("click", function (e) {
            const name = $("#sort_name").val();
            if (name === "") {
                Toast("名称不能为空", 2000);
                return "";
            }
            const js = $("#code").html();
            if(js==="")
                return;
            let regT = /([01\b]\d|2[0-3]):([0-5]\d)/;
            const t1 = $("#time_now").val().match(regT);
            let h1 = 0, m1 = 0;
            if (t1 != null && t1.length >= 3) {
                h1 = parseInt(t1[1])
                m1 = parseInt(t1[2]);
            }

            const jsData = getOneRegularJs(js, $("#shop_name").val(), $("#shop_remark").val(), $("#bill_type").val(), h1, m1, $("#type").val(), $("#price_now").val());
            console.log(jsData)
            try {
                const ret = eval(jsData);
                showTip("自动分类结果：" + ret)
            } catch (e) {
                showTip("自动分类执行出错：" + e)
                // console.log(e)
            }
        });
        $("#save").on("click", function (e) {
            window.AndroidJS.Save("",$("#code").html(),$("#sort_name").val(),$("#sort_remark").val(),$("#cate_id").val());
        });
        setData();
    })



    String.format = function () {
        let s = arguments[0];
        for (let i = 0; i < arguments.length - 1; i++) {
            const reg = new RegExp("%s", "m");
            s = s.replace(reg, arguments[i + 1]);
        }
        return s;
    }


    function getQueryVariable(variable)
    {
        const query = window.location.search.substring(1);
        const vars = query.split("&");
        for (let i=0; i<vars.length; i++) {
            const pair = vars[i].split("=");
            if(pair[0] === variable){return pair[1];}
        }
        return undefined;
    }
    $("#js_style").on('click', function(){
        if ($("#js_style").is(':checked')) {
          //  setCookie("lineWrapping","true",365)
            editor.setOption("lineWrapping",true)
        } else {
        //    setCookie("lineWrapping","false",365)
            editor.setOption("lineWrapping",false)
        }
    });

    function setData() {
        let data = getQueryVariable("data");
        const id = getQueryVariable("id");
        const name=getQueryVariable("name");
        const des=getQueryVariable("des");
       /* const bool=getCookie("lineWrapping")==="true";
        $("#js_style").prop("checked",bool)
        editor.setOption("lineWrapping",bool)*/
        if(data!==undefined&&id!==undefined&&name!==undefined&&des!==undefined){

            $("#cate_id").val(id);
            data=Base64.decode(data)
            editor.setValue(data)

            $("#sort_name").val(decodeURIComponent(name));

            $("#sort_remark").val(decodeURIComponent(des));
           // $("#code").html(data)
        }


    }



    function Toast(msg, duration) {
        duration = isNaN(duration) ? 3000 : duration;
        var m = document.createElement('div');
        m.innerHTML = msg;
        m.style.cssText = "max-width:60%;min-width: 150px;padding:0 14px;height: 40px;color: rgb(255, 255, 255);line-height: 40px;text-align: center;border-radius: 4px;position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 999999;background: rgba(0, 0, 0,.7);font-size: 16px;";
        document.body.appendChild(m);
        setTimeout(function () {
            var d = 0.5;
            m.style.webkitTransition = '-webkit-transform ' + d + 's ease-in, opacity ' + d + 's ease-in';
            m.style.opacity = '0';
            setTimeout(function () {
                document.body.removeChild(m)
            }, d * 1000);
        }, duration);
    }



    function getOneRegularJs(jsData, shopAccount, shopRemark, type, hour, minute, source, money) {
        if (shopAccount == null) shopAccount = "";
        if (shopRemark == null) shopRemark = "";
        var jsInner = "\n" +
            "const isInTimeInner = function (minTime, maxTime,timeHour,timeMinute) {\n" +
            "\n" +
            "    let regT = /([01\\b]\\d|2[0-3]):([0-5]\\d)/;\n" +
            "    const t1 = minTime.match(regT);\n" +
            "    const t2 = maxTime.match(regT);\n" +
            "    if(t1==null||t2==null||t1.length<3||t2.length<3){\n" +
            "        return false;\n" +
            "    }\n" +
            "    const h1 = parseInt(t1[1]), h2 =  parseInt(t2[1]), m1 =  parseInt(t1[2]), m2 =  parseInt(t2[2]);\n" +
            "    if (h1 > h2)\n" +
            "        return (timeHour === h1 && timeMinute >= m1) || timeHour > h1 || timeHour < h2 || timeHour === h2 && timeMinute <= m2;\n" +
            "    else if (h1 < h2)\n" +
            "        return (timeHour === h1 && timeMinute >= m1) || (timeHour > h1 && timeHour < h2) || timeHour === h2 && timeMinute <= m2;\n" +
            "    else if (h1 === h2) {\n" +
            "        if (m1 < m2)\n" +
            "            return timeHour === h1 && timeMinute >= m1 && timeMinute <= m2;\n" +
            "        else if (m1 > m2)\n" +
            "            return (timeHour === h1 && timeMinute >= m1 || timeMinute <= m2) || (timeHour !== h1);\n" +
            "        else\n" +
            "            return m1 === m2 && timeMinute === m1 && timeHour === h1;\n" +
            "    }\n" +
            "};";
        var js = "function getCategory(shopName,shopRemark,type,hour,minute,source,money){%s  %s return '其它';} getCategory('%s','%s','%s',%s,%s,'%s','%s');";
        return String.format(js, jsInner, jsData, shopAccount, shopRemark, type, hour, minute, source, money);
    }

</script>

</body>
</html>
